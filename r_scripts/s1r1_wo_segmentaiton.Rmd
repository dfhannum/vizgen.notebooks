---
title: "Seurat Walkthrough w.r.t Normalization"
author: "D. Ford Hannum"
date: "2023-05-23"
output: html_document
  toc: yes
  toc_depth: 3
  highlight: tango
  number_sections: true
  toc_float: yes
---

```{r setup, include=TRUE, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_knit$set(root.dir = '../data/mouse_brain_showcase/Slice-1_Replicate-1/')
library(Seurat)

# install.packages('arrow')
# install.packages('wkb')
# install.packages('sf')

library(ggplot2)
library(data.table)
```

# Introduction

Here I am going to go through the Seurat pipeline without including any of the cell segmentation (takes the Seurat object from ~4GB to < 1GB). In other notebooks we walk through how to include segmentation. I'd recommend viewing the segmentation in the browser, and there are other walkthroughs about how to include output from Seurat in the visualizer object. 


```{r}
root_dir = '../data/mouse_brain_showcase/Slice-1_Replicate-1/'
print(root_dir)

list.files(root_dir)

```

# Reading into Seurat

```{r}
list.files(root_dir)


counts <- data.table::fread(paste0(root_dir,'./cell_by_gene.csv'))
# table(duplicated(counts$cell))
counts <- as.data.frame(counts)
rownames(counts) <- as.character(counts$cell)

counts <- counts[,-1]
dim(counts)

blanks <- counts[,grepl('Blank', colnames(counts), ignore.case = T)]
dim(blanks)
counts <- counts[,!grepl('Blank', colnames(counts), ignore.case = T)]

md <- as.data.frame(data.table::fread(paste0(root_dir,'./cell_metadata.csv')))
# dim(md) == dim(counts)
rownames(md) <- md$EntityID
# table(rownames(md) == rownames(counts))

counts <- t(counts)
# list.files(root_dir)
transcripts = as.data.frame(data.table::fread(paste0(root_dir,"partitioned_transcripts.csv")))

spat <- CreateSeuratObject(counts =  counts,
                           meta.data = md, 
                           assay = 'Vizgen')

centroids <- md[,c('center_x','center_y','EntityID')]
colnames(centroids) <- c('x','y','cell')
```


```{r}
# x <- ReadVizgen(data.dir = root_dir)
# list.files(root_dir)
# ?ReadVizgen
# 
# ?CreateFOV
```

```{r}

# from
# https://divingintogeneticsandgenomics.rbind.io/post/how-to-construct-a-spatial-object-in-seurat/

coordinates$cell <- data.table::tstrsplit(coordinates$index,'_',keep = 2)[[1]]

# table(coordinates$cell %in% centroids$cell)
# coordinates$x <- coordinates$X
# coordinates$y <- coordinates$Y

coordinates_ <- coordinates[,c('X','Y','cell')]
colnames(coordinates_) <- c('x','y','cell')

coords <- CreateSegmentation(coordinates_)
cents <- CreateCentroids(centroids)
segmentations.data <- list(
  "centroids" = cents,
  "segmentation" = coords
)

coords <- CreateFOV(
  coords = segmentations.data,
  type = c("segmentation", "centroids"),
  molecules = transcripts,
  assay = 'Vizgen'
)

spat[['image']] <- coords

getwd()
saveRDS(spat, '../data/mouse_brain_showcase/Slice-1_Replicate-1/seurat_object2.Rds')

# GetTissueCoordinates(spat[['image']][['segmentation']])
```

# Reloading the data

```{r}
spat <- readRDS('../data/mouse_brain_showcase/Slice-1_Replicate-1/seurat_object.Rds')

# spat[['image']] <- NULL
```


# Processing w/ Seurat

```{r}
start.time <- Sys.time()
spat <- SCTransform(spat, assay = 'Vizgen', 
                    clip.range = c(-10,10))

spat <- RunPCA(spat, npcs = 30, features = rownames(spat))

spat <- RunUMAP(spat, dims = 1:30)

spat <- FindNeighbors(spat, reduction = 'pca', dims = 1:30)
spat <- FindClusters(spat, resolution = 0.3)
end.time <- Sys.time()

start.time - end.time
```

```{r}
DimPlot(spat, reduction = 'umap')
```


```{r}
ImageDimPlot(spat, fov = 'image', cols = 'polychrome', axes = TRUE)
```

```{r}
p1 <- ImageDimPlot(spat, fov = "image", cols = "red", cells = WhichCells(spat, idents = 14))
p2 <- ImageDimPlot(spat, fov = "image", cols = "red", cells = WhichCells(spat, idents = 15))
p1 + p2
```

```{r}
# vizgen.obj <- spat
# 
# install.packages('rgeos')
library(rgeos)
library(future)

# plan('multisession', workers = 4)
# https://github.com/satijalab/seurat/issues/1845
options(future.globals.maxSize = 8000*1024^2)
vizgen.obj <- spat 
cropped.coords <- Crop(vizgen.obj[["image"]], x = c(2500, 3000), y = c(3750, 4250), coords = "plot")
# # set a new field of view (fov)
vizgen.obj[["hippo"]] <- cropped.coords

vizgen.obj[['hippo2']] <- cropped.coords
```

```{r}
ImageDimPlot(vizgen.obj, fov = 'hippo2', axes = TRUE, size = 0.7, border.color = 'white',
             cols = 'polychrome', coord.fixed = T)
```


```{r}
DefaultBoundary(vizgen.obj[['hippo']])
ImageDimPlot(vizgen.obj, fov = 'hippo2', axes = TRUE, size = 0.7, border.color = 'white',
             cols = 'polychrome', coord.fixed = T,boundaries = 'segmentation')
```


```{r}
# sub <- subset(spat, center_x > 1750 & center_x < 3000 & center_y > 3750 & center_y < 5250)
# 
# spat$keep <- spat$center_x > 1750 & spat$center_x < 3000 & spat$center_y < 5250 & spat$center_y > 3750
# 
# table(spat$keep)
# 
# subset_ <- subset(x = spat, subset = keep == TRUE)

```


```{r}
ImageDimPlot(subset_, axes = TRUE, size = 0.7, border.color = 'white', cols ='polychrome',
             coord.fixed = TRUE)

DefaultBoundary(subset_)
```


# Working code/notes

```{r}
sf_data$Geometry[1]

sf::st_coordinates(sf_data$Geometry[1])

x <- lapply(sf_data$Geometry, FUN = sf::st_coordinates)
x_rep <- lapply(sf_data$Geometry, function(x){nrow(sf::st_coordinates(x))})

length(x)
class(x)
length(x[[1]])

dim(x[[1]])

head(x[[1]])
```

```{r}
head(x[[2]])
```

```{r}
# for (i in length(x)){
#   break
#   x[[i]][,'id'] = sf_data[i,]$id
#   x[[i]][,'EntityID'] <- sf_data[i,]$EntityID
#   x[[i]][,'Zindex'] <- sf_data[i,]$ZIndex
# }
# x[[i]][,7] <- 1

x_combined <- do.call(rbind, x)
```

```{r}
sf_data$rep <- do.call(c,x_rep)

t <- sf_data[,]

t2 <- t[rep(seq_len(nrow(t)), each = sf_data$rep),]

sf_data$combined <- paste0(sf_data$ID,'_',sf_data$EntityID,'_',sf_data$ZIndex)

table(rep(sf_data$combined, each = sf_data$rep))

sf_data$combined
sf_data$rep

table(rep(sf_data$combined, sf_data$rep))

x_combined <- as.data.frame(x_combined)
x_combined$index <- rep(sf_data$combined, sf_data$rep)
```


```{r}
sf_data
x_combined[c('ID','EntityID','ZIndex')] <- data.table::tstrsplit(x_combined$index,'_')

head(x_combined)

?geom_polygon
ggplot(x_combined)+ 
  geom_polygon(aes(x = X, y = Y, group = index), fill = NA, colour = 'black')
  
```



