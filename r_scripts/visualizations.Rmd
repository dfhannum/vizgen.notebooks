---
title: "R_Visualizaitons"
author: "D. Ford Hannum"
date: "2023-06-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sfarrow)
library(sf)
library(data.table)
library(ggplot2)

base_path <- '/Users/DouglasHannumJr/Desktop/mouse_brain_showcase_s1r1/'

print(list.files(base_path))
print(list.files(paste0(base_path,'images/')))

```

# Introduction

The eventual goal would be to get this notebook functional on google colab accessing data from AWS s3 buckets. 

Here we will show how to load images (DAPI), segmentation (parquet), and transcripts into one image.

# Transformation Matrix

This is needed to transform the coordinates from global to pixels and visa versa.

```{r}
transformation_matrix <- fread(paste0(base_path,'images/micron_to_mosaic_pixel_transform.csv'),
                               data.table = F)
```

# Parquet File

```{r}
# Reading the file
segs <- sfarrow::st_read_parquet(paste0(base_path,'cell_boundaries.parquet'))
```

```{r}
# Subsetting to z = 3
segs <- segs[segs$ZIndex == 3,]
# Generating centroids for the cells
segs$centroid <- sf::st_centroid(segs$Geometry)
```

```{r}
x <- st_coordinates(segs$centroid)[,1]
y <- st_coordinates(segs$centroid)[,2]

# Using coordinates from region of interest from previous analyses in python
bounds <- c(7000,7250,1000,1250)
bounds_pixel_question <- c(64652,9560,67047,11873)
```

```{r}
# Subsetting to cells whose centroids are in the region of interest
segs$keep <- x > bounds[1] & x < bounds[2] & y > bounds[3] & y < bounds[4]
segs <- segs[segs$keep == T,]
```

```{r}
# Looking at the cell segmentations
plot(st_coordinates(segs))
```

```{r}
# Initializing a data frame to hold cell boundary coordinates
coords_ <- data.frame()

# Gathering the coordinates for each cell
for (i in 1:length(unique(segs$EntityID))){
  
  # Subsetting to one cell/row
  temp <- segs[segs$EntityID == unique(segs$EntityID)[i],]
  
  # Pulling out the coordinates from the geometry
  temp <- as.data.frame(st_coordinates(temp$Geometry))
  
  # Creating an ID column
  temp$EntityID <- unique(segs$EntityID)[i]
  
  # Appending the dataframes to each other
  coords_ <- rbind(coords_, temp)
}


```

```{r}
# Plotting the coords_ with ggplot to better combine with other modalities
ggplot(coords_, aes(x = X, y = Y, group = EntityID)) +
  geom_polygon(alpha = .1)
```

# Transcripts

```{r}
# Loading the transcript file
transcripts <- fread(paste0(base_path,'detected_transcripts.csv'),
                     data.table = F)
```

```{r}
# Subsetting to our region of interest
transcripts <- transcripts[transcripts$global_x > bounds[1] &
            transcripts$global_x < bounds[2] &
            transcripts$global_y > bounds[3] &
            transcripts$global_y < bounds[4],]
```

```{r}
# Plotting all transcripts in the region of interest colored by z-level
ggplot(transcripts, aes(x = global_x, y = global_y,
                        color = global_z)) +
  geom_point(size = .1)
```

```{r}
# Combining transcripts and cell boundaries in global coordinates
ggplot() +
  geom_point(data = transcripts, aes(x = global_x, y = global_y,
                        color = global_z), size = .1) + 
  geom_polygon(data = coords_, aes(x = X, y = Y, group = EntityID), 
               fill = 'red', colour = 'red', alpha = .3) +
  coord_fixed()
```

```{r}
# Converting to pixel coordinates
coords_$x_local <- coords_$X * transformation_matrix[1,1] + transformation_matrix[1,3]
coords_$y_local <- coords_$Y * transformation_matrix[2,2] + transformation_matrix[2,3]

transcripts$x_local <- transcripts$global_x * transformation_matrix[1,1] +
  transformation_matrix[1,3]

transcripts$y_local <- transcripts$global_y * transformation_matrix[2,2] +
  transformation_matrix[2,3]
```

```{r}
min(coords_$x_local)
max(coords_$x_local)
min(coords_$y_local)
max(coords_$y_local)
```

# Image

```{r}
# install.packages('raster')
library(raster)
library(rasterVis)

# Loading the image
raster_obj <- raster('/Users/DouglasHannumJr/Desktop/mouse_brain_showcase_s1r1/images/mosaic_DAPI_z1.tif')

extent(raster_obj)
# Set the window, the y-coordinates are flipped in the raster object so we
# subtract the values from the coords_ & transcripts.
window <- as(extent(64667, 67045,61310 - 11877,61310-9548), 'SpatialPolygons')

# Crop the image to our window
sub <- crop(raster_obj, window)

# Resetting the boundaries of the raster to match with the other modalities
extent(sub) <- c(64667,67045, 9548, 11877)

# Flipping the image to properly align
sub <- flip(sub, direction = 'y')

gplot(sub) +
  geom_tile(aes(fill = value))
```

# Combined Plot

```{r}

# Plotting everything together
gplot(sub) +
  geom_tile(aes(fill = value)) +
  geom_point(data = transcripts[transcripts$global_z == 3,], aes(x = x_local, y = y_local),
             colour = 'green',size = .01) +
  geom_polygon(data = coords_, aes(x = x_local, y = y_local, group = EntityID), 
               fill = 'red', colour = 'red', alpha = .3) +
  coord_fixed()
```

